<!-- wavviz.html -->
<!DOCTYPE html>
<html>
<head>
	<title>wav viz</title>
	<style type="text/css">
body {
	font-size: 62.5%;
}	

#log {
	background-color: black;
	color: car;
}

	</style>
</head>
<body>

	<div id="vizualizer"></div>
	<canvas id="oscilloscope"></canvas>


  <div class="container">
    <h1>wav test</h1>
    <div class="level">
    	<span class="level__label">level</span>
    	<span class="level__display"></span>
    </div>
    <div class="slidecontainer">
		  <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
		  <p>Value: <span id="demo"></span></p>
		</div>
    <section id="log">

    </section>
  </div>

	<script>
	console.log('hello')
	</script>

	<input type="file" id="file-selector" multiple>

	<button class="start">start</button>
	<button class="stop">stop</button>


	<script>

const fileSelector = document.getElementById('file-selector');
const startButton = document.getElementsByClassName('start')[0]
const stopButton = document.getElementsByClassName('stop')[0]

const slider = document.getElementById("myRange");
var output = document.getElementById("demo");
output.innerHTML = slider.value;

slider.oninput = function () {
	output.innerHTML = this.value
}

const levelDisplay = document.getElementsByClassName('level__display')[0]

const log = document.getElementById('log');
function addLog(data) {
	const newLog = document.createElement('div')
	newLog.classList.add('log-item');
	const newContent = document.createTextNode(data);

	log.appendChild(newLog)
}

var AudioContext = window.AudioContext || window.webkitAudioContext;
const audioContext = new AudioContext();

const masterGain = audioContext.createGain();
masterGain.connect(audioContext.destination);

const analyser = audioContext.createAnalyser();
masterGain.connect(analyser);

async function loadSound (event) {

	const self = this;
	const fileList = event.target.files;
	const firstFile = fileList[0];
	const buffer = await firstFile.arrayBuffer();
	// const buf = new Uint8Array(buffer);
	const audioFileSource = await audioContext.decodeAudioData(buffer)

	console.log(audioFileSource)

	function createNewAudioBufSource (audioFileBuffer) {

		const audioDestinationArray = new Float32Array(
				audioFileBuffer.numberOfChannels 
			* audioFileBuffer.duration
			* audioFileBuffer.sampleRate
		);


		audioFileBuffer.copyFromChannel(audioDestinationArray, 0);
		const bufSource = audioContext.createBufferSource();
		bufSource.buffer = audioFileSource;
		return bufSource;
	}

	let audioBufSource = createNewAudioBufSource(audioFileSource);
	// audioBufSource.connect(masterGain);

	console.log(audioBufSource);

	startButton.addEventListener('click', () => {
		audioBufSource.connect(masterGain);
		audioBufSource.start();
	})

	stopButton.addEventListener('click', () => {
		audioBufSource.stop();
		audioBufSource.disconnect();	
		delete audioBufSource.buffer;
		delete audioFileSource;
		audioBufSource = createNewAudioBufSource(audioFileSource);
	})

	slider.oninput = function() {
		const val = (this.value/100) * 3;
	  output.innerHTML = val;
	  audioBufSource.playbackRate = val;
	}


	const waveform = new Float32Array(analyser.frequencyBinCount)
	analyser.getFloatTimeDomainData(waveform)

	;(function updateWaveform() {
	  requestAnimationFrame(updateWaveform)
	  analyser.getFloatTimeDomainData(waveform)

	})()

	const scopeCanvas = document.getElementById('oscilloscope')
	scopeCanvas.width = waveform.length
	scopeCanvas.height = 200
	const scopeContext = scopeCanvas.getContext('2d')
	console.log(self)

	var output = document.getElementById("demo");
	output.innerHTML = slider.value;

	;(function drawOscilloscope() {
		requestAnimationFrame(drawOscilloscope)
		scopeContext.clearRect(0, 0, scopeCanvas.width, scopeCanvas.height)
		scopeContext.beginPath()
		let circle = [0], circle_i = 0;
		for (let i = 0; i < waveform.length; i++) {
		  const x = i
		  const y = (0.5 + waveform[i] / 2) * scopeCanvas.height;
		  if (i == 0) {
		    scopeContext.moveTo(x, y)
		  } else {
		    scopeContext.lineTo(x, y)
		  }
		  // levelDisplay.innerHtml = waveform[0];
			if (i === (waveform.length/4)) {
				scopeContext.font = '50px serif';
				drawText(waveform[0], 50, 90);
				circle_i = circle_i === 100 ? 0 : circle_i + 1;
				if(waveform[i]) {
					circle[circle_i] = waveform[i];
				}
			}
		}
		scopeContext.stroke()

		const something = circle
			.map((x) => x + 0.5)
			.reduce((acc, val) => acc / val)
		drawText(something,  300, 150);
		drawLine(50, 100, something);	
	})()

	function drawText (text, x, y) {
		const xOffset = -20, yOffset = 30
		scopeContext.strokeText(text, x, y);
		scopeContext.fillText(text, x + xOffset, y + yOffset);
	}

	function drawLine (x, y, val) {
		scopeContext.beginPath()
		scopeContext.moveTo(x, y);
		scopeContext.lineTo(x + (500 * val), y)
	  scopeContext.stroke()
	}
}
fileSelector.addEventListener('change', loadSound);

</script>

</body>
</html>